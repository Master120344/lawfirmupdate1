window.addEventListener('DOMContentLoaded', () => {
    const bodyElement = document.body;

    // --- Loader Overlay ---
    const loaderOverlay = document.getElementById('loader-overlay');
    if (loaderOverlay) {
        setTimeout(() => {
            bodyElement.classList.add('loaded');
            setTimeout(() => bodyElement.classList.remove('no-scroll-transition'), 700);
        }, 600);
    } else {
        bodyElement.classList.add('loaded');
        bodyElement.classList.remove('no-scroll-transition');
    }

    // --- Mobile Navigation Panel Toggle ---
    const menuToggleBtn = document.querySelector('.menu-toggle');
    const closeMenuBtn = document.querySelector('.close-menu-toggle');
    const mobileNavPanel = document.getElementById('mobileNavPanel');
    const navPanelLinks = mobileNavPanel ? mobileNavPanel.querySelectorAll('.nav-panel-link') : [];

    function openNavPanel() {
        if (mobileNavPanel && menuToggleBtn) {
            mobileNavPanel.classList.add('open');
            bodyElement.classList.add('nav-panel-open');
            menuToggleBtn.setAttribute('aria-expanded', 'true');
        }
    }
    function closeNavPanel() {
        if (mobileNavPanel && menuToggleBtn) {
            mobileNavPanel.classList.remove('open');
            bodyElement.classList.remove('nav-panel-open');
            menuToggleBtn.setAttribute('aria-expanded', 'false');
        }
    }

    if (menuToggleBtn) menuToggleBtn.addEventListener('click', openNavPanel);
    if (closeMenuBtn) closeMenuBtn.addEventListener('click', closeNavPanel);
    navPanelLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            if (link.getAttribute('href').startsWith('#') && window.location.pathname === link.pathname) {
                // Smooth scroll handled by separate function below
            }
            closeNavPanel();
        });
    });

    // --- Active State for Navigation Links ---
    function setActiveNavLinks() {
        const currentPath = window.location.pathname.split("/").pop() || "index_mobile.html";
        const bottomNavLinks = document.querySelectorAll('.bottom-tab-navigation .tab-item');
        bottomNavLinks.forEach(link => {
            const linkPath = link.getAttribute('href').split("/").pop();
            link.classList.toggle('active', linkPath === currentPath);
            if (linkPath === currentPath) link.setAttribute('aria-current', 'page');
            else link.removeAttribute('aria-current');
        });
        navPanelLinks.forEach(link => {
            const linkPath = link.getAttribute('href').split("/").pop();
            link.classList.toggle('active', linkPath === currentPath);
        });
    }
    setActiveNavLinks();

    // --- Scroll Animations ---
    function setupScrollAnimations() {
        const animatedElements = document.querySelectorAll('.animate-on-scroll');
        if (!animatedElements.length) return;
        const observerOptions = { root: null, rootMargin: '0px 0px -10% 0px', threshold: 0.05 };
        const animationObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const el = entry.target;
                    const delay = parseInt(el.dataset.delay) || 0;
                    el.style.setProperty('--animation-delay-override', `${delay}ms`);
                    el.classList.add('is-visible');
                }
            });
        }, observerOptions);
        animatedElements.forEach(el => animationObserver.observe(el));
    }
    const scrollAnimTimeout = bodyElement.classList.contains('no-scroll-transition') ? 1300 : 100;
    setTimeout(setupScrollAnimations, scrollAnimTimeout);

    // --- Smooth Scroll for Internal Anchor Links ---
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            const href = this.getAttribute('href');
            if (href.length > 1) {
                const targetElement = document.querySelector(href);
                if (targetElement) {
                    e.preventDefault();
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });
    });

    // --- Dynamic Current Year for Footer in Nav Panel ---
    const currentYearSpanMobileNav = document.getElementById('currentYearMobileNav');
    if (currentYearSpanMobileNav) currentYearSpanMobileNav.textContent = new Date().getFullYear();

    console.log("Kershaw Law Mobile JS - Corrected Luxury Edition Initialized");
});