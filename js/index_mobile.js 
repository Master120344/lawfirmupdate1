window.addEventListener('DOMContentLoaded', () => {
    const bodyElement = document.body;

    // --- Loader ---
    const loaderWrapper = document.getElementById('loader-wrapper');
    if (loaderWrapper) {
        setTimeout(() => {
            bodyElement.classList.add('loaded');
            setTimeout(() => bodyElement.classList.remove('no-scroll-transition'), 700);
        }, 300); // Min display time for loader
    } else {
        bodyElement.classList.add('loaded');
        bodyElement.classList.remove('no-scroll-transition');
    }

    // --- Mobile Menu Toggle ---
    const menuToggleBtn = document.querySelector('.menu-toggle-button');
    const closeMenuBtn = document.querySelector('.close-menu-button');
    const mobileMenu = document.getElementById('mobileMenu');
    const navLinksMobile = mobileMenu ? mobileMenu.querySelectorAll('a') : [];

    function openMenu() {
        if (mobileMenu && menuToggleBtn) {
            mobileMenu.classList.add('open');
            bodyElement.classList.add('menu-open');
            menuToggleBtn.setAttribute('aria-expanded', 'true');
        }
    }
    function closeMenu() {
        if (mobileMenu && menuToggleBtn) {
            mobileMenu.classList.remove('open');
            bodyElement.classList.remove('menu-open');
            menuToggleBtn.setAttribute('aria-expanded', 'false');
        }
    }
    if (menuToggleBtn) menuToggleBtn.addEventListener('click', openMenu);
    if (closeMenuBtn) closeMenuBtn.addEventListener('click', closeMenu);
    navLinksMobile.forEach(link => link.addEventListener('click', closeMenu)); // Close menu on link click


    // --- Active Tab Navigation (Bottom Bar) ---
    function setActiveBottomTab() {
        const currentPath = window.location.pathname.split("/").pop() || "index_mobile.html";
        const bottomNavLinks = document.querySelectorAll('.tabs-navigation .tab-item');
        bottomNavLinks.forEach(link => {
            const linkPath = link.getAttribute('href').split("/").pop();
            link.classList.toggle('active', linkPath === currentPath);
            if (linkPath === currentPath) link.setAttribute('aria-current', 'page');
            else link.removeAttribute('aria-current');
        });
    }
    setActiveBottomTab();

    // --- Active Link in Mobile Menu ---
    function setActiveMobileMenuLink() {
        const currentPath = window.location.pathname.split("/").pop() || "index_mobile.html";
         navLinksMobile.forEach(link => {
            const linkPath = link.getAttribute('href').split("/").pop();
            link.classList.toggle('active', linkPath === currentPath);
        });
    }
    if(mobileMenu) setActiveMobileMenuLink();


    // --- Scroll Animations ---
    function setupScrollAnimations() {
        const animatedElements = document.querySelectorAll('.animate-on-scroll');
        if (!animatedElements.length) return;

        const observerOptions = { root: null, rootMargin: '0px 0px -10% 0px', threshold: 0.1 };

        const animationObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach((entry, index) => {
                if (entry.isIntersecting) {
                    const el = entry.target;
                    const delay = parseInt(el.dataset.delay) || 0;
                    const staggerOrder = parseInt(el.dataset.stagger) || index; // For group staggering

                    // Use CSS variables for dynamic delay if preferred, or direct style
                    el.style.setProperty('--animation-delay-override', `${delay}ms`);
                    // el.style.setProperty('--animation-stagger', `${staggerOrder * 100}ms`); // Example stagger

                    el.classList.add('is-visible');
                    // observer.unobserve(el); // Optional: unobserve after first animation
                }
            });
        }, observerOptions);
        animatedElements.forEach(el => animationObserver.observe(el));
    }
    const scrollAnimTimeout = bodyElement.classList.contains('no-scroll-transition') ? 1200 : 100;
    setTimeout(setupScrollAnimations, scrollAnimTimeout);


    // --- Smooth Scroll for # links (e.g., hero "learn more") ---
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            const href = this.getAttribute('href');
            if (href.length > 1) { // Ensure it's not just "#"
                const targetElement = document.querySelector(href);
                if (targetElement) {
                    e.preventDefault();
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });
    });

    // --- Dynamic Current Year for Footer ---
    const currentYearSpan = document.getElementById('currentYear');
    if (currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();

    // --- Testimonial Placeholder Interaction ---
    const testimonialCard = document.querySelector('.testimonial-card');
    if (testimonialCard) {
        const prevBtn = testimonialCard.querySelector('.testimonial-nav-btn[aria-label="Previous testimonial"]');
        const nextBtn = testimonialCard.querySelector('.testimonial-nav-btn[aria-label="Next testimonial"]');
        if(prevBtn) prevBtn.addEventListener('click', () => alert("Previous Testimonial (Demo)"));
        if(nextBtn) nextBtn.addEventListener('click', () => alert("Next Testimonial (Demo)"));
    }

    console.log("Kershaw Law Mobile JS - Superior Edition Initialized");
});